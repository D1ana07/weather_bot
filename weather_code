import asyncio
import datetime
import requests
from aiogram import Bot, Dispatcher
from aiogram.filters import Command
from aiogram.types import Message

BOT_TOKEN = '8156447633:AAFFqEFxNo3oIG9zMRYZsVBoq1n3VImHeNc'
WEATHER_TOKEN = '06eab615f6f5b38b7051e37f3919ae02'

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

@dp.message(Command("start"))
async def start_command(message: Message):
    await message.reply("ğŸŒ¤ï¸ ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ° - Ğ¿Ğ¾ĞºĞ°Ğ¶Ñƒ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñƒ!")

@dp.message()
async def get_weather(message: Message):
    city = message.text.strip()
    print(f"Ğ˜Ñ‰Ñ Ğ³Ğ¾Ñ€Ğ¾Ğ´: {city}")
    
    try:
        url = "http://api.openweathermap.org/data/2.5/weather"
        params = {
            'q': city,
            'lang': 'ru',
            'units': 'metric',
            'appid': WEATHER_TOKEN
        }
        
        response = requests.get(url, params=params)
        print(f"Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°: {response.status_code}")
        print(f"ĞÑ‚Ğ²ĞµÑ‚ API: {response.text}")
        
        data = response.json()
        
        if response.status_code != 200:
            await message.reply("âŒ Ğ“Ğ¾Ñ€Ğ¾Ğ´ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!")
            return
        
        temp = data["main"]["temp"]
        humidity = data["main"]["humidity"]
        pressure = round(data["main"]["pressure"] / 1.333)
        wind = data["wind"]["speed"]
        
        sunrise = datetime.datetime.fromtimestamp(data["sys"]["sunrise"]).strftime('%H:%M')
        sunset = datetime.datetime.fromtimestamp(data["sys"]["sunset"]).strftime('%H:%M')
        
        weather_main = data["weather"][0]["main"]
        emoji = {
            "Clear": "â˜€ï¸", "Clouds": "â˜ï¸", "Rain": "ğŸŒ§ï¸", 
            "Snow": "â„ï¸", "Mist": "ğŸŒ«ï¸"
        }.get(weather_main, "ğŸŒ¤ï¸")
        
        text = f"""ğŸŒ {data['name']}
{emoji} {temp}Â°C
ğŸ’§ {humidity}%
ğŸ“ˆ {pressure} Ğ¼Ğ¼ Ñ€Ñ‚.ÑÑ‚.
ğŸ’¨ {wind} Ğ¼/Ñ
â˜€ï¸ {sunrise}
ğŸŒ… {sunset}"""
        
        await message.reply(text)
        
    except:
        await message.reply("âŒ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ°!")

async def main():
    print("ğŸš€ Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½!")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
